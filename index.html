<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bao - å¦æ¡‘å°¼äºšåŒäººå¯¹æˆ˜æ£‹</title>
    
    <!-- å¼•å…¥ Tailwind CSS è¿›è¡Œé¡µé¢æ ·å¼å¸ƒå±€ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- å¼•å…¥ Babel ä½¿å¾—æµè§ˆå™¨å¯ä»¥ç›´æ¥è§£æ JSX è¯­æ³• -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* é˜»æ­¢ç§»åŠ¨ç«¯æµè§ˆå™¨çš„é»˜è®¤ä¸‹æ‹‰åˆ·æ–°å’ŒåŒå‡»ç¼©æ”¾ï¼Œæå‡æ¸¸æˆä½“éªŒ */
        body {
            touch-action: none;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            background-color: #2D1A11; /* æ·±æœ¨è‰²èƒŒæ™¯ */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // === å¸¸é‡å’Œè·¯å¾„å®šä¹‰ ===
        // P1 æ§åˆ¶ r=0 (åæ–¹) å’Œ r=1 (å‰çº¿) - ä½äºå±å¹•å·¦ä¾§
        // P1è§†è§’ï¼šæ‰‹æœºé¡¶éƒ¨æ˜¯å·¦ï¼Œåº•éƒ¨æ˜¯å³ã€‚é¡ºæ—¶é’ˆæ„å‘³ç€ï¼šå‰æ’ä»å·¦åˆ°å³(c=0->7)ï¼Œåæ’ä»å³åˆ°å·¦(c=7->0)
        const P1_CW = [
            [0, 7], [0, 6], [0, 5], [0, 4], [0, 3], [0, 2], [0, 1], [0, 0],
            [1, 0], [1, 1], [1, 2], [1, 3], [1, 4], [1, 5], [1, 6], [1, 7]
        ];
        const P1_CCW = [...P1_CW].reverse();

        // P2 æ§åˆ¶ r=2 (å‰çº¿) å’Œ r=3 (åæ–¹) - ä½äºå±å¹•å³ä¾§
        // P2è§†è§’ï¼šæ‰‹æœºåº•éƒ¨æ˜¯å·¦ï¼Œé¡¶éƒ¨æ˜¯å³ã€‚é¡ºæ—¶é’ˆæ„å‘³ç€ï¼šå‰æ’ä»å·¦åˆ°å³(c=7->0)ï¼Œåæ’ä»å³åˆ°å·¦(c=0->7)
        // (å·²ä¿®å¤ P2 çš„é€»è¾‘ï¼Œç¡®ä¿ä¸ç©å®¶å®é™…ç‰©ç†è§†è§’å®Œå…¨å¯¹åº”)
        const P2_CW = [
            [3, 0], [3, 1], [3, 2], [3, 3], [3, 4], [3, 5], [3, 6], [3, 7],
            [2, 7], [2, 6], [2, 5], [2, 4], [2, 3], [2, 2], [2, 1], [2, 0]
        ];
        const P2_CCW = [...P2_CW].reverse();

        const getPath = (player, dir) => {
            if (player === 1) return dir === 'CW' ? P1_CW : P1_CCW;
            return dir === 'CW' ? P2_CW : P2_CCW;
        };

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        function BaoGame() {
            const [board, setBoard] = useState(() => Array(4).fill(null).map(() => Array(8).fill(2)));
            const [turn, setTurn] = useState(1); // 1 æˆ– 2
            const [directions, setDirections] = useState({ 1: null, 2: null });
            const [animating, setAnimating] = useState(false);
            const [winner, setWinner] = useState(null);
            
            const [selectedPit, setSelectedPit] = useState(null);
            const [activePit, setActivePit] = useState(null);
            const [capturePit, setCapturePit] = useState(null);

            const checkWinCondition = (currentBoard) => {
                const p1Frontline = currentBoard[1].reduce((sum, val) => sum + val, 0);
                const p2Frontline = currentBoard[2].reduce((sum, val) => sum + val, 0);
                
                if (p1Frontline === 0) return 2; // P1 å‰çº¿ç©ºäº†ï¼ŒP2 èµ¢
                if (p2Frontline === 0) return 1; // P2 å‰çº¿ç©ºäº†ï¼ŒP1 èµ¢
                return 0;
            };

            const handlePitClick = async (r, c) => {
                if (animating || winner) return;
                if (board[r][c] === 0) return;
                
                // åªèƒ½ç‚¹å‡»è‡ªå·±é¢†åœ°çš„æ ¼å­
                if (turn === 1 && r > 1) return;
                if (turn === 2 && r < 2) return;

                // é¦–æ¬¡è¡Œæ£‹éœ€è¦é€‰æ‹©æ–¹å‘
                if (!directions[turn]) {
                    setSelectedPit({ r, c });
                    return;
                }

                await runTurn(r, c, directions[turn]);
            };

            const chooseDirection = async (dir) => {
                const { r, c } = selectedPit;
                setSelectedPit(null);
                setDirections(prev => ({ ...prev, [turn]: dir }));
                await runTurn(r, c, dir);
            };

            const runTurn = async (startR, startC, dir) => {
                setAnimating(true);
                let currentBoard = JSON.parse(JSON.stringify(board));
                
                let seeds = currentBoard[startR][startC];
                currentBoard[startR][startC] = 0;
                setActivePit({ r: startR, c: startC });
                setBoard([...currentBoard]);
                await sleep(300);

                const path = getPath(turn, dir);
                let currIdx = path.findIndex(p => p[0] === startR && p[1] === startC);
                
                let steps = 0;
                while (seeds > 0 && steps < 2000) {
                    steps++;
                    currIdx = (currIdx + 1) % path.length;
                    let [r, c] = path[currIdx];

                    seeds--;
                    let wasEmpty = currentBoard[r][c] === 0;
                    currentBoard[r][c]++;
                    setActivePit({ r, c });
                    setBoard(JSON.parse(JSON.stringify(currentBoard)));
                    await sleep(250);

                    if (seeds === 0) {
                        if (wasEmpty) {
                            break;
                        } else {
                            let isFrontline = (turn === 1 && r === 1) || (turn === 2 && r === 2);
                            let oppR = turn === 1 ? 2 : 1;
                            let oppSeeds = currentBoard[oppR][c];

                            if (isFrontline && oppSeeds > 0) {
                                setCapturePit({ r: oppR, c });
                                currentBoard[oppR][c] = 0;
                                currentBoard[r][c] += oppSeeds;
                                setBoard(JSON.parse(JSON.stringify(currentBoard)));
                                await sleep(500);
                                setCapturePit(null);
                            }

                            let winCheck = checkWinCondition(currentBoard);
                            if (winCheck) {
                                setWinner(winCheck);
                                setAnimating(false);
                                setActivePit(null);
                                return;
                            }

                            seeds = currentBoard[r][c];
                            currentBoard[r][c] = 0;
                            setBoard(JSON.parse(JSON.stringify(currentBoard)));
                            await sleep(300);
                        }
                    }
                }

                let finalWinCheck = checkWinCondition(currentBoard);
                if (finalWinCheck) {
                    setWinner(finalWinCheck);
                } else {
                    setTurn(turn === 1 ? 2 : 1);
                }
                
                setAnimating(false);
                setActivePit(null);
            };

            const resetGame = () => {
                setBoard(Array(4).fill(null).map(() => Array(8).fill(2)));
                setTurn(1);
                setDirections({ 1: null, 2: null });
                setWinner(null);
                setAnimating(false);
                setSelectedPit(null);
                setActivePit(null);
                setCapturePit(null);
            };

            const isPlayerArea = (r, player) => {
                return (player === 1 && r <= 1) || (player === 2 && r >= 2);
            };

            // UI ç»„ä»¶ï¼šç©å®¶ä¾§è¾¹æ 
            const PlayerSidebar = ({ player, isLeft }) => {
                const isActive = turn === player && !winner;
                const rotateClass = isLeft ? 'rotate-90' : '-rotate-90';
                
                return (
                    <div className={`w-16 sm:w-24 transition-colors duration-500 flex flex-col items-center justify-center relative shadow-2xl z-20 ${isActive ? 'bg-[#D35400]' : 'bg-[#5D4037]'}`}>
                        <div className={`flex flex-col items-center justify-center transform ${rotateClass} whitespace-nowrap`}>
                            <h2 className={`text-2xl sm:text-3xl font-black drop-shadow-md ${isActive ? 'text-white' : 'text-[#A1887F]'}`}>
                                ç©å®¶ {player}
                            </h2>
                            
                            {/* æ˜¾ç¤ºé€‰æ‹©çš„æ–¹å‘ */}
                            <div className={`mt-2 transition-opacity duration-300 ${directions[player] ? 'opacity-100' : 'opacity-0'}`}>
                                <div className="bg-black/30 text-[#FFECB3] px-3 py-1.5 rounded-full text-xs sm:text-sm font-bold flex items-center gap-1.5">
                                    <span className="text-lg leading-none">{directions[player] === 'CW' ? 'â†»' : 'â†º'}</span>
                                    <span>{directions[player] === 'CW' ? 'é¡ºæ—¶é’ˆ' : 'é€†æ—¶é’ˆ'}</span>
                                </div>
                            </div>

                            {/* å›åˆæŒ‡ç¤ºå™¨ */}
                            {isActive && (
                                <div className="absolute -bottom-8 animate-bounce">
                                    <div className="bg-white text-[#D35400] text-xs font-bold px-3 py-1 rounded-full shadow-lg">
                                        æ€è€ƒä¸­
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                // æ•´ä½“é‡‡ç”¨æ°´å¹³å¸ƒå±€ (æ¨ªæ’: P1ä¾§è¾¹æ  - æ£‹ç›˜ - P2ä¾§è¾¹æ )
                <div className="flex flex-row h-screen w-screen bg-[#3E2723] font-sans overflow-hidden select-none">
                    
                    {/* å·¦ä¾§ï¼šç©å®¶ 1 */}
                    <PlayerSidebar player={1} isLeft={true} />

                    {/* ä¸­é—´ï¼šæ£‹ç›˜åŒºåŸŸ */}
                    <div className="flex-1 bg-[#DCAE78] relative flex items-center justify-center p-2 sm:p-4 shadow-[inset_0_0_50px_rgba(0,0,0,0.5)]">
                        
                        {/* æ£‹ç›˜æœ¨æ¿åº•åº§ */}
                        <div className="bg-[#795548] p-3 sm:p-5 rounded-3xl shadow-2xl border-4 border-[#5D4037] relative">
                            
                            {/* å‰çº¿åˆ†å‰²çº¿ (å‚ç›´ç»˜åˆ¶åœ¨ä¸­é—´) */}
                            <div className="absolute top-4 bottom-4 left-1/2 w-1.5 sm:w-2 bg-[#3E2723] opacity-40 transform -translate-x-1/2 rounded-full pointer-events-none"></div>

                            {/* æ£‹ç›˜ç½‘æ ¼ï¼š8è¡Œ(å¯¹åº”åˆ—c) x 4åˆ—(å¯¹åº”è¡Œr) */}
                            <div className="grid grid-cols-4 gap-2 sm:gap-3 relative z-10">
                                {[...Array(8)].map((_, c) => (
                                    <React.Fragment key={c}>
                                        {[...Array(4)].map((_, r) => {
                                            const seeds = board[r][c];
                                            const isClickable = !animating && !winner && isPlayerArea(r, turn) && seeds > 0;
                                            const isActive = activePit?.r === r && activePit?.c === c;
                                            const isCaptured = capturePit?.r === r && capturePit?.c === c;
                                            
                                            // P1(å·¦)çš„æ•°å­—é¡ºæ—¶é’ˆè½¬90åº¦ï¼ŒP2(å³)çš„æ•°å­—é€†æ—¶é’ˆè½¬90åº¦
                                            const numRotateClass = r < 2 ? 'rotate-90' : '-rotate-90';
                                            
                                            return (
                                                <div
                                                    key={`${r}-${c}`}
                                                    onClick={() => isClickable && handlePitClick(r, c)}
                                                    className={`
                                                        relative w-12 h-12 sm:w-16 sm:h-16 rounded-full flex items-center justify-center text-xl sm:text-2xl font-black transition-all duration-300
                                                        ${isPlayerArea(r, 1) ? 'bg-[#A1887F] text-[#4E342E]' : 'bg-[#8D6E63] text-[#3E2723]'}
                                                        ${isActive ? 'ring-4 ring-yellow-400 scale-110 shadow-[0_0_20px_rgba(253,224,71,1)] z-20 bg-[#FFE082] text-[#E65100]' : 'shadow-[inset_0_5px_10px_rgba(0,0,0,0.4)]'}
                                                        ${isCaptured ? 'ring-4 ring-red-500 bg-red-500 text-white scale-90' : ''}
                                                        ${isClickable ? 'cursor-pointer hover:ring-4 hover:ring-white/50' : ''}
                                                    `}
                                                >
                                                    {seeds > 0 ? (
                                                        <span className={`inline-block transition-transform duration-300 ${numRotateClass}`}>
                                                            {seeds}
                                                        </span>
                                                    ) : null}
                                                </div>
                                            );
                                        })}
                                    </React.Fragment>
                                ))}
                            </div>
                        </div>

                        {/* æ–¹å‘é€‰æ‹©å¼¹çª— (è¦†ç›–åœ¨å„è‡ªçš„åŠåœº) */}
                        {selectedPit && (
                            <div className={`absolute inset-y-0 ${turn === 1 ? 'left-0 right-1/2' : 'left-1/2 right-0'} bg-black/60 z-30 flex items-center justify-center backdrop-blur-sm`}>
                                <div className={`bg-[#F4D03F] p-4 sm:p-6 rounded-2xl shadow-2xl flex flex-col items-center gap-4 sm:gap-6 border-4 border-[#E67E22] transform ${turn === 1 ? 'rotate-90' : '-rotate-90'}`}>
                                    <h3 className="text-lg sm:text-xl font-black text-[#873600]">è¯·é€‰æ‹©è¡Œæ£‹æ–¹å‘</h3>
                                    <div className="flex gap-4 sm:gap-6">
                                        <button onClick={() => chooseDirection('CW')} className="flex flex-col items-center bg-[#D35400] text-white w-20 h-20 sm:w-24 sm:h-24 justify-center rounded-xl hover:bg-[#E67E22] active:scale-95 transition-transform shadow-lg">
                                            <span className="text-3xl font-bold">â†»</span>
                                            <span className="mt-1 text-sm sm:text-base font-bold">é¡ºæ—¶é’ˆ</span>
                                        </button>
                                        <button onClick={() => chooseDirection('CCW')} className="flex flex-col items-center bg-[#D35400] text-white w-20 h-20 sm:w-24 sm:h-24 justify-center rounded-xl hover:bg-[#E67E22] active:scale-95 transition-transform shadow-lg">
                                            <span className="text-3xl font-bold">â†º</span>
                                            <span className="mt-1 text-sm sm:text-base font-bold">é€†æ—¶é’ˆ</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* å³ä¾§ï¼šç©å®¶ 2 */}
                    <PlayerSidebar player={2} isLeft={false} />

                    {/* æ¸¸æˆç»“æŸå¼¹çª— - åŒæ—¶ä¸ºä¸¤ä¾§ç©å®¶æä¾›è§†è§‰é€‚é… */}
                    {winner && (
                        <div className="absolute inset-0 bg-black/80 z-50 flex flex-row items-center justify-around p-4 backdrop-blur-md">
                            {/* é¢å‘ç©å®¶ 1 (å·¦ä¾§) */}
                            <div className="transform rotate-90 flex-1 flex flex-col items-center text-center">
                                <h2 className="text-4xl font-black text-white mb-2">{winner === 1 ? 'ğŸ‰ èƒœåˆ©' : 'ğŸ’” å¤±è´¥'}</h2>
                                <p className="text-xl text-[#F4D03F] font-bold mb-6">ç©å®¶ {winner} è·å¾—äº†æ¯”èµ›</p>
                                <button onClick={resetGame} className="bg-[#D35400] text-white text-lg font-bold py-3 px-8 rounded-full shadow-lg active:scale-95">å†æ¥ä¸€å±€</button>
                            </div>
                            
                            {/* é¢å‘ç©å®¶ 2 (å³ä¾§) */}
                            <div className="transform -rotate-90 flex-1 flex flex-col items-center text-center border-l-2 border-white/20 pl-4">
                                <h2 className="text-4xl font-black text-white mb-2">{winner === 2 ? 'ğŸ‰ èƒœåˆ©' : 'ğŸ’” å¤±è´¥'}</h2>
                                <p className="text-xl text-[#F4D03F] font-bold mb-6">ç©å®¶ {winner} è·å¾—äº†æ¯”èµ›</p>
                                <button onClick={resetGame} className="bg-[#D35400] text-white text-lg font-bold py-3 px-8 rounded-full shadow-lg active:scale-95">å†æ¥ä¸€å±€</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // æ¸²æŸ“ React ç»„ä»¶åˆ°é¡µé¢ä¸­
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BaoGame />);
    </script>
</body>
</html>
